version: "3.7"

services: 
    gitlab:
      image: 'gitlab/gitlab-ee:latest'
      hostname: 'gitlab'
      container_name: ${GITLAB_CONTAINER_NAME}
      environment:
        GITLAB_OMNIBUS_CONFIG: |
          external_url 'https://192.168.221.1'
          gitlab_rails['gitlab_shell_ssh_port'] = 422
          # Add any other gitlab.rb configuration here, each on its own line
      ports:
        - "${GITLAB_HTTP_PORT}:80"
        - "${GITLAB_HTTPS_PORT}:443"
        - "${GITLAB_SSH_PORT}:22"
      volumes:
        - 'gitlab_config:/etc/gitlab'
        - 'gitlab_logs:/var/log/gitlab'
        - 'gitlab_data:/var/opt/gitlab'
      networks: 
        - final-project

    jenkins:
      image: jenkinsci/blueocean
      container_name: ${JENKINS_CONTAINER_NAME}
      ports:
        - "${JENKINS_HTTP_PORT}:8080"
        - "${JENKINS_SERVICE_PORT}:50000"
      user: ${JENKINS_USER}
      environment:
        DOCKER_HOST: ${JENKINS_DOCKER_HOST}
        DOCKER_CERT_PATH: ${JENKINS_DOCKER_CERT_PATH}
        DOCKER_TLS_VERIFY: ${JENKINS_DOCKER_TLS_VERIFY}
      volumes:
        - jenkins_data:/var/jenkins_home
        - docker_certs:/certs/client:ro
        - .gitconfig:/root/.gitconfig
      networks: 
        - final-project
      depends_on:
        - docker

    docker:
      image: docker:dind
      privileged: true
      container_name: ${DOCKER_CONTAINER_NAME}
      environment:
        DOCKER_TLS_CERTDIR: ${DOCKER_TLS_CERTDIR}
      volumes:
        - jenkins_data:/var/jenkins_home
        - docker_certs:/certs/client
        - docker_data:/var/lib/docker
      networks: 
        - final-project

    zabbix:
      image: zabbix/zabbix-appliance:latest
      container_name: ${ZABBIX_CONTAINER_NAME}
      ports: 
        - "${ZABBIX_HTTP_PORT}:80"
        - "${ZABBIX_SERVICE_PORT}:10051"
      volumes: 
        - zabbix_data:/var/lib/mysql
        - zabbix_alert_script:/usr/lib/zabbix/alertscripts/
      networks: 
        - final-project

    registry:
      image: registry:2
      container_name: ${REGISTRY_CONTAINER_NAME}
      ports: 
        - "${REGISTRY_SERVICE_PORT}:5000"
      volumes: 
        - docker_repo:/var/lib/registry
      networks: 
        - final-project

    registry-ui:
      image: parabuzzle/craneoperator:latest
      container_name: ${REGISTRY_UI_CONTAINER_NAME}
      ports:
        - "${REGISTRY_UI_HTTP_PORT}:80"
      environment:
        - REGISTRY_HOST=${REGISTRY_HOST}
        - REGISTRY_PORT=${REGISTRY_SERVICE_PORT}
        - REGISTRY_PROTOCOL=${REGISTRY_PROTOCOL}
        - SSL_VERIFY=${SSL_VERIFY}
      networks: 
        - final-project
      
networks: 
    final-project:

volumes: 
    gitlab_config:
    gitlab_logs:
    gitlab_data:
    jenkins_data:
    zabbix_data:
    docker_repo:
    docker_data:
    docker_certs:
    zabbix_alert_script:

